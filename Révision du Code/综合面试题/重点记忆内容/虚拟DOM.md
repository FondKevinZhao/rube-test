谈谈 Vue 中的虚拟 dom

什么是虚拟 DOM？

虚拟 DOM 是区别于真实的 DOM 提出的。

数据类型：对象，它只是一个普通的 js 对象。



在 js 事件直接操作 DOM 的时代（包括 Jquery 的时代），我们通过 JS 直接对真实的 DOM 树进行增删改查。

但是 JS 事件直接操作 DOM 会随着项目规模的扩大、事件的增加导致事件的管理以及事件和 DOM 之间的关系的维护变得日益复杂。

为了解决这个问题，以 Vue 为代表的新型前端框架（包括 react 等）提出了引入数据中间层来避免直接操作 DOM 的思路：让前端框架底层代替用户去操作 DOM，用户不再关注 DOM 元素，而聚焦于数据（state）。使用 Vue 等框架，我们只需要修改数据，数据变化后 Vue 帮助我们来更新 DOM。

所谓的虚拟 DOM 并不是一个真正的 DOM 树，它是 Vue 底层在检测到数据修改后，不立刻直接去修改真实的 DOM，而是结合数据和模板，生成一个临时的由 js 对象模拟的 DOM 树。



**当数据发生变化时，vue 是怎么更新节点的？**

要知道渲染真实 DOM 的开销是很大的，比如有时候我们修改了某个数据，如果直接渲染到真实 dom 上会引起整个 dom 树的重绘和重排，有没有可能我们只更新我们修改的那一小块 dom 而不要更新整个 dom 呢？diff 算法能够很好的帮助我们。

我们先根据真实 DOM 生成一颗`virtual DOM`，当`virtual DOM`某个节点的数据改变后会生成一个新的`Vnode`，然后`Vnode`和`oldVnode`作对比，发现有不一样的地方就直接修改在真实的 DOM 上，然后使`oldVnode`的值为 `Vnode`。

diff 的过程就是调用名为 `patch` 的函数，比较新旧节点，一边比较一边给**真实的DOM**打补丁。

**virtual DOM 和真实 DOM 的区别？**

virtual DOM 是将真实的 DOM 的数据抽取出来，以对象的形式模拟树形结构。



**DOM 比较策略：**

在更新时会生成新的虚拟 dom，这时候新旧虚拟 dom 会进行比较，差别化更新。

1. 如果新旧节点不一样，会直接创建一个新标签替换老标签。

2. 如果标签一样，文本不一样，会用新的文本替换老的文本。

3. 如果标签一样，比较属性，设置属性和样式。

4. 新旧节点对比子节点策略:

   4-1. 如果老节点有孩子，新节点没孩子，直接清空老节点孩子。

   4-2. 如果新节点有孩子，老节点没孩子，直接循环遍历新节点依次添加。

   4-3. 如果都有孩子，内部会采用双指针的方式进行比较，先对比头，头如果不一样，会进行尾尾比较，如果尾不一样，会进行老头和新尾比较，如果还不一样，会进行老尾和新头比较，**注意：**在比较的时候会先判断标签是否一样，在判断 key 是否一样，判断 key 的好处在于尽最大可能复用老节点，key 对比 index 的好处是：key不会发生变化，而 index 可能会发生变化，导致判断失误没有复用老节点，如果最后这些比较都不一样，会进行乱序比较。



**key 的作用：**

为了复用之前的数据而提高渲染速度，只修改或者增加元素不影响其他的元素渲染。

当遍历的数据发生变化的时候，此时组件会生成全新的虚拟 DOM 树，并与旧的虚拟 DOM 树进行对比(对比条件包括 key)，找到可以复用的真实 DOM节点，去复用这些真实节点，提高代码运行。
**注意：**复用的是上一次生成的真实 DOM 节点。



**使用 index 作为 key 值，可能会出现什么问题?**
**注意：**其实平常开发中，如果遍历的数据不会发生变化，用 index 是没有问题的。
input 案例
		此案例中，diff 算法生效了，可以复用之前 key 值相同的元素，但是复用错了。
商城商品列表排序
		此案例中，diff 算法失效了，明明具有数据相同的节点可以完全复用，但是由于 key 值问题，导致所有节点都不能复用。



**使用数据的唯一标识作为 key 的好处：**
	只要服务器数据不发生变化，我前端页面的节点就可以永远复用。