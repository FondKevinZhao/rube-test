# day03

## 虚拟 DOM Diff 算法

React 对新旧虚拟 DOM 树比较时，进行了三种优化，来提升比较的速度

## tree diff

1. 原因：开发时，我们进行跨层级移动节点较少，可以忽略不计，所以我们生成的 DOM 树结构很稳定

2. tree diff 策略

- 只进行相同层级的节点比较，从上到下依次比较
- 如果比较新旧 DOM 节点相同，继续比较子节点，如果不同，就不对比子节点了

3. 避免跨层级移动节点，如果真的需要，通过 css 去控制

## component diff

1. 原因：相同类的组件生成相似的结构，不同类的组件生成不同的结构

2. component diff 策略

- 比较时，如果对比的节点时组件，走 component diff
- 对比组件是否是同一类的组件
  - 是
    - 默认会对组件子节点进行 tree diff
    - 此时可以优化，定义 shouldComponentUpdate 函数
      - 内部判断新旧 state 和 props 是否发生变化，如果有变化就返回 true，如果都没有变化就返回 false（返回 false 就会跳过子节点的比较）
  - 不是，就删除旧组件，替换成新组件

3. 尽量复用组件

## element diff

1. 原因：相同层级的多个子节点进行操作时，性能不好（往前面追加元素）

2. element diff 策略

- 给相同层级的多个子节点都要添加一个 key 属性，值是唯一的
- 比较新旧 DOM 节点时，优先比较 key，key 相同还要看位置，都相等，就不动，位置不同就要移动位置，key 不同就要重新创建节点

3. key 的值能用 id 用 id，如果想使用 index，只能用于数组最后面的操作

## 谈谈原型

1. 原型是什么

- 原型指的是两个属性：`prototype` 和 `__proto__`
  - `prototype`叫做显示原型属性
  - `__proto__`叫做隐式原型属性

2. 原型属性有什么特点，有什么内容

- 显示原型属性

  - 除了箭头函数以外其他所有函数都有显示原型属性
  - 它的值是一个对象，叫做原型对象
    - `constuctor`方法，指向函数本身
    - `__proto__`属性，默认指向 `Object.prototype`

- 隐式原型属性
  - 所有对象都有隐式原型属性
  - 它的值指向其构造函数的显示原型属性的值（或者说原型对象的值）

3. 其他内容

- 所有数组都是 new Array 产生的，所以数组的隐式原型属性指向 Array 显示原型属性，显示原型属性上有很多数组的方法：map、reduce、filter、some 等，数组的方法都是继承自 Array 显示原型属性上的
- 所有函数都是 new Function 产生的，所以函数的隐式原型属性指向 Function 显示原型属性，显示原型属性上有很多函数的方法：call、apply、bind 等，数组的方法都是继承自 Function 显示原型属性上的

4. 特殊情况

- `Function.__proto__ === Function.prototype`
- `Object.prototype.__proto__ === null` 这也是原型链的尽头

5. 原型链

- 概念：由多个隐式原型属性组成的结构叫做原型链
- 作用：查找对象的属性/方法
- 规则：
  - 先在自身属性上查找，找到就返回值
  - 再沿着隐式原型属性一层层找，找到就返回值
  - 最终回来到`Object.prototype.__proto__`，返回值是 undefined

6. 原型属性的作用：用来继承属性/方法，从而复用
7. 原型属性的应用：

- 在 React 中，定义类组件，其中实例对象通过原型属性继承父类的方法，比如 setState

## 总结 this 指向

普通函数 this 指向，主要看调用方式，而箭头函数看定义方式

1. 普通函数

- 直接调用，this 指向 window，在严格模式下，指向 undefined
- 隐式调用（对象调用方法），this 指向调用的对象
- 显示调用（通过 call、apply 调用函数），this 指向传入的第一个参数
- new 调用，this 指向生成实例对象

2. 箭头函数

- this 指向，离他最近的外层函数的 this
- 和调用无关

3. 回调函数

- 定时器回调函数、ajax 回调函数
  - this 指向 window，在严格模式下，指向 undefined
- DOM 事件回调函数
  - this 指向绑定事件的 DOM 元素
- React 中的生命周期函数
  - this 指向组件实例对象
- React 中事件回调函数
  - 定义普通函数形式：this 指向 undefined
  - 定义箭头函数形式：this 指向组件实例对象
